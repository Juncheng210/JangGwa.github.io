<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="View 点击事件的传递规则首先,用户触摸屏幕的时候系统必须对事件做出相应反应.而这个事件就是产生一个 MotionEvent 然后按照一定的规则传递给每一个 View 去进行相应的处理.这就是我们所谓的事件分发了.点击事件的分发主要设计一下几个主要的方法:">
<meta property="og:type" content="article">
<meta property="og:title" content="View的事件分发机制">
<meta property="og:url" content="http://yoursite.com/2016/07/17/View的事件分发机制/index.html">
<meta property="og:site_name" content="JangGwa's home">
<meta property="og:description" content="View 点击事件的传递规则首先,用户触摸屏幕的时候系统必须对事件做出相应反应.而这个事件就是产生一个 MotionEvent 然后按照一定的规则传递给每一个 View 去进行相应的处理.这就是我们所谓的事件分发了.点击事件的分发主要设计一下几个主要的方法:">
<meta property="og:image" content="https://github.com/hanhailong/AndroidStudyResources/blob/master/screenshot/view_touch_ignorant.png?raw=true">
<meta property="og:image" content="https://github.com/hanhailong/AndroidStudyResources/blob/master/screenshot/view_touch_interested.png?raw=true">
<meta property="og:image" content="https://raw.githubusercontent.com/hanhailong/AndroidStudyResources/master/screenshot/view_touch_intercept.png">
<meta property="og:updated_time" content="2016-09-12T00:24:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="View的事件分发机制">
<meta name="twitter:description" content="View 点击事件的传递规则首先,用户触摸屏幕的时候系统必须对事件做出相应反应.而这个事件就是产生一个 MotionEvent 然后按照一定的规则传递给每一个 View 去进行相应的处理.这就是我们所谓的事件分发了.点击事件的分发主要设计一下几个主要的方法:">
<meta name="twitter:image" content="https://github.com/hanhailong/AndroidStudyResources/blob/master/screenshot/view_touch_ignorant.png?raw=true">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"right","display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/07/17/View的事件分发机制/"/>

  <title> View的事件分发机制 | JangGwa's home </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=57943924";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">JangGwa's home</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                View的事件分发机制
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-17T21:14:24+08:00" content="2016-07-17">
              2016-07-17
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/17/View的事件分发机制/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/17/View的事件分发机制/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/07/17/View的事件分发机制/" class="leancloud_visitors" data-flag-title="View的事件分发机制">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="View-点击事件的传递规则"><a href="#View-点击事件的传递规则" class="headerlink" title="View 点击事件的传递规则"></a>View 点击事件的传递规则</h3><p>首先,用户触摸屏幕的时候系统必须对事件做出相应反应.而这个事件就是产生一个 MotionEvent 然后按照一定的规则传递给每一个 View 去进行相应的处理.这就是我们所谓的事件分发了.点击事件的分发主要设计一下几个主要的方法:<a id="more"></a></p>
<p>用来进行事件的分发.如果有事件传递给当前的 View ,那么该 View 一定会去调用这个方法</p>
<p>返回值受当前 View 的 onTouchEvent 和下级 View 的 dispatchTouchEvent 的影响</p>
<p>返回值表示当前的事件时候已经被处理完成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent e)</span></span></div></pre></td></tr></table></figure>
<p>这个方法在上面那个方法中内部调用,用来判断是否拦截这个事件</p>
<p>如果当前View拦截了某个事件 那么在同一个事件序列中就不会再次被调用</p>
<p>返回值表示是否拦截当前事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent e)</span></span></div></pre></td></tr></table></figure>
<p>也是在第一个方法中去调用 用来处理拦截下来的事件</p>
<p>返回值为真表示该事件已经被处理 否则 没有处理 </p>
<p>在同一事件序列中View无法再次接收到事件 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent e)</span></span></div></pre></td></tr></table></figure>
<p>可以用一段伪代码来表示一下三者的关系:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent e)</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">boolean</span> consume = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (onInterceptTouchEvent(e)) &#123;</div><div class="line"></div><div class="line">consume = onTouchEvent(e);</div><div class="line"></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">cnsume = childView.dispathcTouchEvent(e);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">return</span> cosume;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的代码中我们基本可以总结出这样的结论:<br><strong><em>对于一个根 ViewGroup 来说,当接收到一个 MotionEvent 的时候:</em></strong><br>调用 dispatchTouchEvent 方法调用 onInterceptTouchEvent 方法返回值为 true ,则表示拦截当前事件,调用 onTouchEvent 来处理这个事件<br>返回值为 false ,则当前事件将会被传递给 childView,childView 继续调用 dispatchTouchEvent 方法</p>
<p>如此往复,直至事件被处理.<br><strong><em>当一个 View 需要处理一个事件的时候</em></strong><br>如果该View设置了 onTouchListener ,则会调用 onTouch 方法如果 onTouch 方法返回 false,则去调用 onTouchEvent 如果设置了 onClickListener ,那么在 onTouchEvent 方法中将会调用 onClick 方法</p>
<p>反之, onTouchEvent 则不会被调用</p>
<p>当一个事件产生的时候,它的传递过程遵循这样的过程: Activity-&gt;Windows-&gt;View;事件总是先传递给 Activity,Activity 在传递给 Windows,Windows 在传递给 View;如果 View 将事件处理了,则该事件相应就结束了.否则,事件将一级一级的继续返回,最终会传递给 Activity 的 onTouchEvent 处理.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line"></div><div class="line">Toast.makeText(MainActivity.<span class="keyword">this</span>, event.getAction() + <span class="string">"我是Activity"</span>, Toast.LENGTH_SHORT).show();</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当你没有给任何控件设置相应事件的时候(也就是都会返回 false),那么你就会看到 Activity 的 onTouchEvent 被调用了.<br>在开发艺术这本书中提到了几个结论:<br>1.同一个事件序列是指手指接触屏幕那一刻起,到手指离开屏幕那一刻结束,在这个过程中所有产生的事件都属于这一个事件序列.包括一个 ACTION_DOWN ,一个 ACTION_UP 和n个 ACTION_MOVE;</p>
<p>2.某一个 View 一旦决定拦截事件,那么这一事件序列都只能由它来处理.</p>
<p>这个结论认真想了一下,似乎有点问题;假如这个 View 我设置了 onTouchListener ,但是我依然返回 false ,这个事件序列仍然会传递给父 View ,当然了,这个 View 也只能接收到一个ACTION_DOWN事件,ACTION_UP和ACTION_MOVE不会接收到.假如这个 View 同时还设置了 onClickListener,onTouchEvent 返回 false 的时候事件会交给 onTouchEvent 处理这个事件,不会在交给父 View 处理了.这个问题还是需要结合源码来看一下;<br>3.某个 View 一旦开始处理一个事件,如果它不消耗 ACTION_DOWN 事件,那么同一时间序列也不会交给他来处理了.</p>
<p>4.如果 View 不消耗 ACTION_DWON 以外的事件,那么这个点击事件就会消失,不会在交还给父 View 处理.最后会交回 activity 处理.</p>
<ol>
<li>ViewGroup 默认不拦截任何事件,他的 onInterceptTouch 方法默认返回 false ;View 没有 onInterceptTouch 方法,收到事件他的 onTouchEvent 事件就会被调用.</li>
</ol>
<p>6.View 的 onTouchEvent 默认都会消耗事件(返回true),除非他是不可点击的(clickable和龙Clickable同时为false).View 的 longClickable 默认都是 false,clickable 分情况.</p>
<h3 id="Activity-对事件的分发"><a href="#Activity-对事件的分发" class="headerlink" title="Activity 对事件的分发"></a>Activity 对事件的分发</h3><p>点击事件用 MotionEvent 来表示,当点击事件发生的时候,事件最先传递给当前 Activity,由 Activity 的 dispatchTouchEvent 来进行事件派发,具体工作是由 Activity 内部的 Windows 来处理的.Windows 会将事件传递给 decor view,即当前 View 的root view.先看一下 Activity 的 dispatchTouchEvent 源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">diapatchTouchEvent</span><span class="params">(MotionEvent e)</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (e.getAction() == MotionEvent.ACTION_DOWN) &#123;</div><div class="line"></div><div class="line">onUserInteraction();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (getWindows.superDispatchTouchEvent()) &#123;</div><div class="line"></div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">return</span> onTouchEvent(e);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有个 onUserInteraction<br>方法,点进去发现这个方法是一个空方法,文档是这样写的:</p>
<blockquote>
<p>Called whenever a key, touch, or trackball event is dispatched to the activity. Implement this method if you wish to know that the user has interacted with the device in some way while your activity is running. This callback and onUserLeaveHint() are intended to help activities manage status bar notifications intelligently; specifically, for helping activities determine the proper time to cancel a notfication. All calls to your activity’s onUserLeaveHint() callback will be accompanied by calls to onUserInteraction(). This ensures that your activity will be told of relevant user activity such as pulling down the notification pane and touching an item there. Note that this callback will be invoked for the touch down action that begins a touch gesture, but may not be invoked for the touch-moved and touch-up actions that follow.</p>
</blockquote>
<p>大体意思就是说 onUserInteraction 是帮助我们知道用户开始和屏幕进行交互的回调函数.另外,还会和 onUserLeaveHint<br>一起更加智能的管理状态栏通知.</p>
<blockquote>
<p>Called as part of the activity lifecycle when an activity is about to go into the background as the result of user choice. For example, when the user presses the Home key, onUserLeaveHint() will be called, but when an incoming phone call causes the in-call Activity to be automatically brought to the foreground, onUserLeaveHint() will not be called on the activity being interrupted. In cases when it is invoked, this method is called right before the activity’s onPause() callback. This callback and onUserInteraction() are intended to help activities manage status bar notifications intelligently; specifically, for helping activities determine the proper time to cancel a notfication.</p>
</blockquote>
<p>这里这两个方法对我们不是很重要了,根据分析可以知道,activity 通过 windows 来分发事件,当所有的 view 都没有接收处理事件的时候,activity 就会自己调用自己的<code>onTouchEvent()</code>来处理这个事件了.<br>继续看<code>getWindows.superDispatchTouchEvent()</code><br>,window 是个抽象类</p>
<blockquote>
<p>Abstract base class for a top-level window look and behavior policy. An instance of this class should be used as the top-level view added to the window manager. It provides standard UI policies such as a background, title area, default key processing, etc. The only existing implementation of this abstract class is android.view.PhoneWindow, which you should instantiate when needing a Window.</p>
</blockquote>
<p>根据文档的描述,我们可以知道 window<br>的唯一实现类是 android.view.PhoneWindow<br> ,那么他的 dispatchTouchEvent 是怎么实现的呢?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//PhoneWindow#superDispatchTouchEvent</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">superDispatchTouchEvent</span><span class="params">(MotionEvent e)</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">return</span> mDecor.superDispatchTouchEvent(e);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的思路很清晰了,直接分发给 mDecor 处理,那么 DecorView 是什么东西呢?<a href="http://blog.csdn.net/windskier/article/details/6957854" target="_blank" rel="external">关于activity的层次点击这里</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//this is the top-level view of the window,containing the window decor(装饰)</span></div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DecorView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">RootViewSurfaceTaker</span></span></div><div class="line"></div><div class="line"><span class="title">private</span> <span class="title">DecorView</span> <span class="title">mDecor</span>;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> View <span class="title">getDecorView</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (<span class="keyword">null</span> == mDecor) &#123;</div><div class="line"></div><div class="line">installDecor();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">return</span> mDecor;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到了这事件会继续分发,到我们通过 setContentView 设置的 ViewGroup 那里继续处理.</p>
<h3 id="ViewGroup-对事件的分发"><a href="#ViewGroup-对事件的分发" class="headerlink" title="ViewGroup 对事件的分发"></a>ViewGroup 对事件的分发</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Check for interception.</span></div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN|| mFirstTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!disallowIntercept) &#123;</div><div class="line"></div><div class="line">intercepted = onInterceptTouchEvent(ev);</div><div class="line"></div><div class="line">ev.setAction(action); <span class="comment">// restore action in case it was changed</span></div><div class="line"></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">intercepted = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line"><span class="comment">// There are no touch targets and this action is not an initial down</span></div><div class="line"></div><div class="line"><span class="comment">// so this view group continues to intercept touches.</span></div><div class="line"></div><div class="line">intercepted = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这段代码是来判断是否要来拦截当前的点击事件的.可以看出当这个事件是一个事件序列的开端,也就是一个 ACTION_DOWN,就用去调用 onInterceptTouch 方法去判断是否要去拦截这个事件;或者当 mFirstTouchTarget 不为空的时候,也会去判断.相反,就不会拦截了.这也说明了一个事件如果 View 不去处理他的ACTION_DWON事件为什么就能在去处理其他的事件了.<br>当 ViewGroup 不处理事件要继续分发的时候代码是这样的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</div><div class="line"></div><div class="line"><span class="comment">// Find a child that can receive the event.</span></div><div class="line"></div><div class="line"><span class="comment">// Scan children from front to back.</span></div><div class="line"></div><div class="line"><span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = buildOrderedChildList();</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></div><div class="line"></div><div class="line">&amp;&amp; isChildrenDrawingOrderEnabled();</div><div class="line"></div><div class="line"><span class="keyword">final</span> View[] children = mChildren;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">int</span> childIndex = customOrder</div><div class="line"></div><div class="line">? getChildDrawingOrder(childrenCount, i) : i;</div><div class="line"></div><div class="line"><span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</div><div class="line"></div><div class="line">? children[childIndex] : preorderedList.get(childIndex);</div><div class="line"></div><div class="line"><span class="comment">// If there is a view that has accessibility focus we want it</span></div><div class="line"></div><div class="line"><span class="comment">// to get the event first and if not handled we will perform a</span></div><div class="line"></div><div class="line"><span class="comment">// normal dispatch. We may do a double iteration but this is</span></div><div class="line"></div><div class="line"><span class="comment">// safer given the timeframe.</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (childWithAccessibilityFocus != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (childWithAccessibilityFocus != child) &#123;</div><div class="line"></div><div class="line"><span class="keyword">continue</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">childWithAccessibilityFocus = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">i = childrenCount - <span class="number">1</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!canViewReceivePointerEvents(child)</div><div class="line"></div><div class="line">|| !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</div><div class="line"></div><div class="line">ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</div><div class="line"></div><div class="line"><span class="keyword">continue</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">newTouchTarget = getTouchTarget(child);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (newTouchTarget != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line"><span class="comment">// Child is already receiving touch within its bounds.</span></div><div class="line"></div><div class="line"><span class="comment">// Give it the new pointer in addition to the ones it is handling.</span></div><div class="line"></div><div class="line">newTouchTarget.pointerIdBits |= idBitsToAssign;</div><div class="line"></div><div class="line"><span class="keyword">break</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">resetCancelNextUpFlag(child);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</div><div class="line"></div><div class="line"><span class="comment">// Child wants to receive touch within its bounds.</span></div><div class="line"></div><div class="line">mLastTouchDownTime = ev.getDownTime();</div><div class="line"></div><div class="line"><span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line"><span class="comment">// childIndex points into presorted list, find original index</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; childrenCount; j++) &#123;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (children[childIndex] == mChildren[j]) &#123;</div><div class="line"></div><div class="line">mLastTouchDownIndex = j;</div><div class="line"></div><div class="line"><span class="keyword">break</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">mLastTouchDownIndex = childIndex;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">mLastTouchDownX = ev.getX();</div><div class="line"></div><div class="line">mLastTouchDownY = ev.getY();</div><div class="line"></div><div class="line">newTouchTarget = addTouchTarget(child, idBitsToAssign);</div><div class="line"></div><div class="line">alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</div><div class="line"></div><div class="line"><span class="keyword">break</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// The accessibility focus didn't handle the event, so clear</span></div><div class="line"></div><div class="line"><span class="comment">// the flag and do a normal dispatch to all children.</span></div><div class="line"></div><div class="line">ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>逻辑也比清晰,遍历 ViewGroup 的所有子 View,找出能接受事件的所有元素;要满足两个条件:1.坐标是否落在子 View 中2.是否正在播放动画.满足这两个条件,就会分发给他来处理,要是返回了 true 就表示事件已经被处理, mFirstTouchTarget 就会被赋值并终止此次分发,否则继续分发过程.</p>
<h3 id="View-对点击事件的处理过程"><a href="#View-对点击事件的处理过程" class="headerlink" title="View 对点击事件的处理过程"></a>View 对点击事件的处理过程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//View#dispatchTouchEvent</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> (onFilterTouchEventForSecurity(event)) &#123;</div><div class="line"></div><div class="line"><span class="comment">//noinspection SimplifiableIfStatement</span></div><div class="line"></div><div class="line">ListenerInfo li = mListenerInfo;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnTouchListener != <span class="keyword">null</span></div><div class="line"></div><div class="line">&amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED</div><div class="line"></div><div class="line">&amp;&amp; li.mOnTouchListener.onTouch(<span class="keyword">this</span>, event)) &#123;</div><div class="line"></div><div class="line">result = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!result &amp;&amp; onTouchEvent(event)) &#123;</div><div class="line"></div><div class="line">result = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里相对比较简单,首先判断是否设置了 onTouchListener,如果设置了就去调用 onTouch 方法,如果返回了 false,则去调用 onTouchEvent 方法; <strong><em>在 view 设置了 onClickListener 或者 onLongClickListener 后,会自动将 CLICKABLE 或者 LONG_CLICKABLE 变成 ture;</em></strong></p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>三张图十分清晰的描述事件分发,效果图如下：<br>View 不处理事件流程图（View 没有消费事件）<a href="https://github.com/hanhailong/AndroidStudyResources/blob/master/screenshot/view_touch_ignorant.png?raw=true" target="_blank" rel="external"><img src="https://github.com/hanhailong/AndroidStudyResources/blob/master/screenshot/view_touch_ignorant.png?raw=true" alt="Touch Ignore"></a><br>View 处理事件<a href="https://github.com/hanhailong/AndroidStudyResources/blob/master/screenshot/view_touch_interested.png?raw=true" target="_blank" rel="external"><img src="https://github.com/hanhailong/AndroidStudyResources/blob/master/screenshot/view_touch_interested.png?raw=true" alt="Touch interest"></a><br>事件拦截<a href="https://raw.githubusercontent.com/hanhailong/AndroidStudyResources/master/screenshot/view_touch_intercept.png" target="_blank" rel="external"><img src="https://raw.githubusercontent.com/hanhailong/AndroidStudyResources/master/screenshot/view_touch_intercept.png" alt="Touch Intercept"></a></p>
<h3 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h3><p>以后每个知识点的实践学习代码会上传到我的 <a href="https://github.com/JangGwa" target="_blank" rel="external">GitHub</a>,欢迎大家一起学习-.-~</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag">#Android</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/07/16/View的基础知识/" rel="next" title="View的基础知识">
                <i class="fa fa-chevron-left"></i> View的基础知识
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/22/酷炫的音量调节控件/" rel="prev" title="酷炫的音量调节控件">
                酷炫的音量调节控件 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/07/17/View的事件分发机制/"
           data-title="View的事件分发机制" data-url="http://yoursite.com/2016/07/17/View的事件分发机制/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpg"
               alt="JangGwa" />
          <p class="site-author-name" itemprop="name">JangGwa</p>
          <p class="site-description motion-element" itemprop="description">努力程度之低的社会里，根本轮不到拼天赋</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">20</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/JangGwa" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/JangGwa" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/users/2c187eb3c3fa/top_articles" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  简书
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://yifeiyuan.me/" title="程序亦非猿" target="_blank">程序亦非猿</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://codekk.com/" title="CodeKK" target="_blank">CodeKK</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://stormzhang.com/" title="stormzhang" target="_blank">stormzhang</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.jianshu.com/users/9038233c5f2c/latest_articles" title="达达达达sky" target="_blank">达达达达sky</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.jianshu.com/users/ec95b5891948/latest_articles" title="D_clock爱吃葱花" target="_blank">D_clock爱吃葱花</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://hukai.me/" title="胡凯" target="_blank">胡凯</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://drakeet.me/" title="drakeet" target="_blank">drakeet</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.csdn.net/lzyzsd/" title="大头鬼" target="_blank">大头鬼</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.inferjay.com/" title="脉脉不得语" target="_blank">脉脉不得语</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#View-点击事件的传递规则"><span class="nav-number">1.</span> <span class="nav-text">View 点击事件的传递规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Activity-对事件的分发"><span class="nav-number">2.</span> <span class="nav-text">Activity 对事件的分发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ViewGroup-对事件的分发"><span class="nav-number">3.</span> <span class="nav-text">ViewGroup 对事件的分发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#View-对点击事件的处理过程"><span class="nav-number">4.</span> <span class="nav-text">View 对点击事件的处理过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最后"><span class="nav-number">5.</span> <span class="nav-text">最后</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#附录"><span class="nav-number">6.</span> <span class="nav-text">附录</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JangGwa</span>
</div>

<div class="powered-by">
由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
主题 -
<a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
NexT.Mist
</a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
</br>本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span id="busuanzi_value_site_uv"></span>人次


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"JangGwa"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("T5dAeGqxiFdUgYXnU893VxKP-gzGzoHsz", "aoR9ALM1z8EznTQ3if7PEk2S");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
